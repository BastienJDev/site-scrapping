<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLLINA Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">EP</div>
                <span class="logo-text">POLLINA</span>
            </div>
            
            <nav class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v8h8V3H3zM13 3v8h8V3h-8zM3 13v8h8v-8H3zM13 13v8h8v-8h-8z"/>
                    </svg>
                    <span>Accueil</span>
                </a>
                
                <a href="{{ url_for('actualites') }}" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <span>Actualit√©s</span>
                </a>
                
                <a href="#" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    <span>Offres d'emploi</span>
                </a>
                
                <div class="nav-item nav-dropdown">
                    <div class="nav-dropdown-toggle">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                        </svg>
                        <span>Sites juridiques</span>
                        <span class="nav-caret">‚ñæ</span>
                    </div>
                    <div class="nav-dropdown-menu">
                        <button type="button" class="nav-subitem" data-dalloz-trigger>Dalloz</button>
                    </div>
                </div>
                
                <a href="#" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m5.2-15.8l-4.2 4.2m-5.7 5.7l-4.2 4.2M23 12h-6m-6 0H1m15.8 5.2l-4.2-4.2m-5.7-5.7l-4.2-4.2"/>
                    </svg>
                    <span>Autres</span>
                </a>
                
                <a href="{{ url_for('sites_manager') }}" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    <span>G√©rer les sites</span>
                </a>
            </nav>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar">{{ username[0].upper() if username else 'U' }}</div>
                    <span class="user-name">{{ username }}</span>
                </div>
                <a href="{{ url_for('logout') }}" class="btn-logout" title="D√©connexion">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </a>
            </div>
        </aside>
        
        <!-- Main content area -->
        <main class="main-content">
            <div class="content-header">
                <h1>Actualit√©s</h1>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">üåê</div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalSites">0</div>
                        <div class="stat-label">Sites enregistr√©s</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìÅ</div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalCategories">0</div>
                        <div class="stat-label">Cat√©gories</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <div class="stat-value" id="recentScrapes">0</div>
                        <div class="stat-label">Scrapings r√©cents</div>
                    </div>
                </div>
            </div>
            
            <!-- Section Scraping -->
            <div class="scraping-container">
                <div class="scraping-header">
                    <div class="header-content">
                        <h2>üöÄ Recherche par date</h2>
                        <p>S√©lectionnez les sites et les options d'extraction</p>
                    </div>
                </div>
                
                <form id="scrapingForm" class="scraping-form-modern">
                    <!-- Date Range Section -->
                    <div class="date-range-section">
                        <label class="date-range-label">
                            <span class="date-icon">üìÖ</span>
                            <span>Plage de dates</span>
                        </label>
                        <div class="date-range-inputs">
                            <div class="date-input-group">
                                <label for="dateStart">Du</label>
                                <input type="date" id="dateStart" name="dateStart" class="date-input">
                            </div>
                            <div class="date-input-group">
                                <label for="dateEnd">Au</label>
                                <input type="date" id="dateEnd" name="dateEnd" class="date-input">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prompt Section -->
                    <div class="prompt-section">
                        <label for="userPrompt" class="prompt-label">
                            <span class="prompt-icon">üí¨</span>
                            <span>Votre prompt</span>
                        </label>
                        <textarea 
                            id="userPrompt" 
                            name="userPrompt" 
                            class="prompt-textarea" 
                            placeholder="D√©crivez ce que vous souhaitez extraire ou analyser..."
                            rows="3"></textarea>
                    </div>
                    
                    <!-- Type Selection Cards -->
                    <div class="selection-cards">
                        <div class="selection-card active" data-type="site">
                            <input type="radio" name="scrapingType" value="site" id="typeSite" checked>
                            <label for="typeSite">
                                <div class="card-icon">üåê</div>
                                <div class="card-title">Site unique</div>
                                <div class="card-desc">Scraper un site sp√©cifique</div>
                            </label>
                        </div>
                        
                        <div class="selection-card" data-type="category">
                            <input type="radio" name="scrapingType" value="category" id="typeCategory">
                            <label for="typeCategory">
                                <div class="card-icon">üìÅ</div>
                                <div class="card-title">Cat√©gories</div>
                                <div class="card-desc">Scraper plusieurs cat√©gories</div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Site/Category Selection -->
                    <div class="selection-container">
                        <div id="siteSelection" class="site-list">
                            <h3>S√©lectionner les sites</h3>
                            <div class="search-box">
                                <input type="text" id="searchSites" placeholder="üîç Rechercher un site...">
                            </div>
                            <div id="sitesCheckboxList" class="checkbox-list">
                                <!-- Sites will be inserted here -->
                            </div>
                        </div>
                        
                        <div id="categorySelection" class="category-list" style="display: none;">
                            <div class="selection-title">
                                <h3>S√©lectionner les cat√©gories</h3>
                                <button type="button" class="btn-tertiary" id="checkAllCategories">
                                    Tout cocher
                                </button>
                            </div>
                            <div id="categoriesCheckboxList" class="checkbox-list checkbox-list-visible">
                                <!-- Categories will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options -->
                    <div class="options-section">
                        <h3>Options de scraping</h3>
                        <div class="options-grid">
                            <div class="option-card">
                                <div class="option-header">
                                    <span class="option-icon">üìä</span>
                                    <span class="option-title">Niveau d'exploration</span>
                                </div>
                                <select id="scrapingDepth" class="modern-select">
                                    <option value="0">Niveau 0 - Page principale</option>
                                    <option value="1">Niveau 1 - Liens directs</option>
                                    <option value="2">Niveau 2 - Sous-liens</option>
                                    <option value="3">Niveau 3 - Profond</option>
                                </select>
                                
                                <div class="gemini-checkbox-container">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="geminiSummary" name="geminiSummary">
                                        <span class="checkbox-text">Demander un r√©sum√© √† Gemini</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetForm()">R√©initialiser</button>
                        <button type="submit" class="btn-launch">
                            <span>‚ñ∂</span> Lancer le scraping
                        </button>
                    </div>
                </form>
                
                <!-- Progress -->
                <div id="scrapingProgress" class="scraping-progress" style="display: none;">
                    <div class="progress-info">
                        <span id="progressText">En cours...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="scrapingResults" class="scraping-results" style="display: none;">
                <!-- Results will be inserted here by JavaScript -->
            </div>
            
        </main>
    </div>
    
    <script>
        // Copie du script de index.html avec ajout de la gestion des dates
        let sites = [];
        let categories = [];
        
        async function loadStats() {
            sites = await fetch('/api/sites').then(r => r.json());
            categories = await fetch('/api/categories').then(r => r.json());
            
            document.getElementById('totalSites').textContent = sites.length;
            document.getElementById('totalCategories').textContent = categories.length;
            
            const sitesCheckboxList = document.getElementById('sitesCheckboxList');
            sitesCheckboxList.innerHTML = '';
            
            sites.forEach(site => {
                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox-item';
                checkbox.dataset.name = site.name.toLowerCase();
                checkbox.dataset.category = (site.category_name || '').toLowerCase();
                checkbox.innerHTML = `
                    <input type="checkbox" id="site_${site.id}" value="${site.id}" class="site-checkbox">
                    <label for="site_${site.id}">
                        <span class="checkbox-name">${site.name}</span>
                    </label>
                `;
                sitesCheckboxList.appendChild(checkbox);
            });
            
            const categoriesCheckboxList = document.getElementById('categoriesCheckboxList');
            categoriesCheckboxList.innerHTML = '';
            
            categories.forEach(cat => {
                const siteCount = sites.filter(s => s.category_id === cat.id).length;
                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox-item';
                checkbox.innerHTML = `
                    <input type="checkbox" id="cat_${cat.id}" value="${cat.id}" class="category-checkbox">
                    <label for="cat_${cat.id}">
                        <span class="radio-color" style="background: ${cat.color}"></span>
                        <span class="checkbox-name">${cat.name}</span>
                        <span class="radio-count">${siteCount} site(s)</span>
                    </label>
                `;
                categoriesCheckboxList.appendChild(checkbox);
            });
        }
        
        document.querySelectorAll('.selection-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.selection-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                const type = this.dataset.type;
                const isSite = type === 'site';
                
                document.getElementById('siteSelection').style.display = isSite ? 'block' : 'none';
                document.getElementById('categorySelection').style.display = isSite ? 'none' : 'block';
            });
        });
        
        const searchInput = document.getElementById('searchSites');
        const checkboxList = document.getElementById('sitesCheckboxList');
        
        searchInput.addEventListener('focus', () => {
            checkboxList.classList.add('checkbox-list-visible');
        });
        
        searchInput.addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase().trim();
            
            if (search === '') {
                checkboxList.classList.remove('checkbox-list-visible');
                document.querySelectorAll('.checkbox-item').forEach(item => {
                    item.style.display = 'flex';
                    item.classList.remove('search-highlight');
                });
                updateSearchCounter(0, sites.length);
                return;
            }
            
            checkboxList.classList.add('checkbox-list-visible');
            
            let visibleCount = 0;
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const name = item.dataset.name || '';
                const category = item.dataset.category || '';
                const matches = name.includes(search) || category.includes(search);
                
                if (matches) {
                    item.style.display = 'flex';
                    item.classList.add('search-highlight');
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                    item.classList.remove('search-highlight');
                }
            });
            
            updateSearchCounter(visibleCount, sites.length);
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.site-list')) {
                checkboxList.classList.remove('checkbox-list-visible');
            }
        });
        
        function updateSearchCounter(visible, total) {
            let counter = document.getElementById('searchCounter');
            if (!counter) {
                counter = document.createElement('div');
                counter.id = 'searchCounter';
                counter.className = 'search-counter';
                document.querySelector('.search-box').appendChild(counter);
            }
            counter.textContent = visible > 0 ? `${visible} / ${total} sites` : `${total} sites`;
        }
        
        updateSearchCounter(0, sites.length);
        
        document.getElementById('checkAllCategories').addEventListener('click', () => {
            document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = true);
        });
        
        function resetForm() {
            document.getElementById('userPrompt').value = '';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            document.querySelectorAll('.site-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('scrapingDepth').value = '0';
            document.getElementById('geminiSummary').checked = false;
            document.getElementById('searchSites').value = '';
            document.querySelectorAll('.checkbox-item').forEach(item => item.style.display = 'flex');
        }
        
        document.getElementById('scrapingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // R√©cup√©rer le type depuis la carte active
            const activeCard = document.querySelector('.selection-card.active');
            const type = activeCard ? activeCard.dataset.type : 'site';
            const depth = parseInt(document.getElementById('scrapingDepth').value);
            const useGemini = document.getElementById('geminiSummary').checked;
            let userPrompt = document.getElementById('userPrompt').value.trim();
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            
            // Ajouter les dates au prompt si renseign√©es
            if (dateStart || dateEnd) {
                const dateInfo = [];
                if (dateStart) dateInfo.push(`√† partir du ${dateStart}`);
                if (dateEnd) dateInfo.push(`jusqu'au ${dateEnd}`);
                const dateSuffix = `\n\nP√©riode de recherche: ${dateInfo.join(' ')}`;
                userPrompt = userPrompt ? userPrompt + dateSuffix : `Chercher les actualit√©s ${dateInfo.join(' ')}`;
            }
            
            const progressDiv = document.getElementById('scrapingProgress');
            const resultsDiv = document.getElementById('scrapingResults');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            let sitesToScrape = [];
            
            if (type === 'site') {
                const checkedSites = document.querySelectorAll('.site-checkbox:checked');
                checkedSites.forEach(cb => {
                    const siteId = parseInt(cb.value);
                    const site = sites.find(s => s.id === siteId);
                    if (site) sitesToScrape.push(site);
                });
            } else {
                const checkedCategories = document.querySelectorAll('.category-checkbox:checked');
                
                if (checkedCategories.length === 0) {
                    // Si aucune cat√©gorie n'est coch√©e, prendre tous les sites
                    sitesToScrape = [...sites];
                } else {
                    // Sinon, prendre uniquement les sites des cat√©gories coch√©es
                    checkedCategories.forEach(cb => {
                        const categoryId = parseInt(cb.value);
                        const categorySites = sites.filter(s => s.category_id === categoryId);
                        sitesToScrape.push(...categorySites);
                    });
                }
            }
            
            if (sitesToScrape.length === 0) {
                alert('Aucun site disponible pour le scraping');
                return;
            }
            
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            submitBtn.disabled = true;
            
            document.getElementById('progressText').textContent = 
                `Scraping ${sitesToScrape.length} site${sitesToScrape.length > 1 ? 's' : ''}...`;
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressBarFill').style.width = '0%';
            
            const results = {
                success: 0,
                failed: 0,
                details: [],
                gemini_summary: null
            };
            
            try {
                const response = await fetch('/api/scrape-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sites: sitesToScrape.map(s => ({ id: s.id, url: s.url, name: s.name })),
                        depth: depth,
                        use_gemini: useGemini,
                        prompt: userPrompt
                    })
                });
                
                document.getElementById('progressPercent').textContent = '50%';
                document.getElementById('progressBarFill').style.width = '50%';
                
                const batchResult = await response.json();
                
                document.getElementById('progressPercent').textContent = '100%';
                document.getElementById('progressBarFill').style.width = '100%';
                
                if (batchResult.success) {
                    results.success = batchResult.total_scraped;
                    results.failed = batchResult.total_failed;
                    results.gemini_summary = batchResult.gemini_summary;
                    
                    batchResult.results.forEach(r => {
                        if (r.success) {
                            results.details.push({
                                site: r.site,
                                status: 'success',
                                data: r
                            });
                        } else {
                            results.details.push({
                                site: r.site,
                                status: 'error',
                                error: r.error || 'Unknown error'
                            });
                        }
                    });
                } else {
                    results.failed = sitesToScrape.length;
                    sitesToScrape.forEach(site => {
                        results.details.push({
                            site: site.name,
                            status: 'error',
                            error: batchResult.error || 'Batch scraping failed'
                        });
                    });
                }
            } catch (error) {
                results.failed = sitesToScrape.length;
                sitesToScrape.forEach(site => {
                    results.details.push({
                        site: site.name,
                        status: 'error',
                        error: error.message
                    });
                });
            }
            
            // Afficher les r√©sultats (m√™me code que index.html)
            progressDiv.style.display = 'none';
            resultsDiv.style.display = 'block';
            
            const successCount = results.success;
            const failedCount = results.failed;
            const totalCount = successCount + failedCount;
            const successPercent = Math.round((successCount / totalCount) * 100);
            
            resultsDiv.innerHTML = `
                <div class="results-card">
                    <div class="results-header">
                        <h3>R√©sultats du scraping</h3>
                        <div class="results-badge">${totalCount} site${totalCount > 1 ? 's' : ''} trait√©${totalCount > 1 ? 's' : ''}</div>
                    </div>
                    
                    ${results.gemini_summary ? `
                    <div class="gemini-summary" style="margin-bottom: 24px;">
                        <div class="gemini-header">
                            <span class="gemini-icon">‚ú®</span>
                            <strong>R√©sum√© Global Gemini</strong>
                        </div>
                        <div class="gemini-content">${results.gemini_summary.replace(/\n/g, '<br>')}</div>
                    </div>
                    ` : ''}
                    
                    <div class="results-overview">
                        <div class="overview-stat success-stat">
                            <div class="stat-icon-large">‚úì</div>
                            <div class="stat-content">
                                <div class="stat-number">${successCount}</div>
                                <div class="stat-label">R√©ussis</div>
                            </div>
                        </div>
                        
                        ${failedCount > 0 ? `
                        <div class="overview-stat error-stat">
                            <div class="stat-icon-large">‚úï</div>
                            <div class="stat-content">
                                <div class="stat-number">${failedCount}</div>
                                <div class="stat-label">√âchou√©s</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="overview-stat info-stat">
                            <div class="stat-icon-large">%</div>
                            <div class="stat-content">
                                <div class="stat-number">${successPercent}%</div>
                                <div class="stat-label">Taux de r√©ussite</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-list">
                        ${results.details.map(detail => `
                            <div class="result-card ${detail.status}">
                                <div class="result-header">
                                    <span class="result-status-icon">${detail.status === 'success' ? '‚úì' : '‚úï'}</span>
                                    <h4>${detail.site}</h4>
                                </div>
                                ${detail.status === 'success' ? 
                                    `<div class="result-content">
                                        <div class="result-info">
                                            <span class="info-label">Titre de la page</span>
                                            <div class="info-value">${detail.data.title || 'Non disponible'}</div>
                                        </div>
                                        
                                        ${detail.data.meta_description ? `
                                        <div class="result-info">
                                            <span class="info-label">Description</span>
                                            <div class="info-value">${detail.data.meta_description}</div>
                                        </div>
                                        ` : ''}
                                        
                                        <div class="result-metrics">
                                            <div class="metric">
                                                <span class="metric-value">${detail.data.links_found || 0}</span>
                                                <span class="metric-label">Liens trouv√©s</span>
                                            </div>
                                            <div class="metric">
                                                <span class="metric-value">${detail.data.headings?.length || 0}</span>
                                                <span class="metric-label">Titres (H1-H3)</span>
                                            </div>
                                        </div>
                                        
                                        ${detail.data.gemini_summary ? `
                                        <div class="gemini-summary">
                                            <div class="gemini-header">
                                                <span class="gemini-icon">‚ú®</span>
                                                <strong>R√©sum√© Gemini</strong>
                                            </div>
                                            <div class="gemini-content">${detail.data.gemini_summary.replace(/\n/g, '<br>')}</div>
                                        </div>
                                        ` : ''}
                                        
                                        <div class="details-accordion">
                                            ${detail.data.headings?.length > 0 ? `
                                            <div class="accordion-item">
                                                <button class="accordion-header" onclick="toggleAccordion(this)">
                                                    <span>üìã Titres trouv√©s (${detail.data.headings.length})</span>
                                                    <span class="accordion-icon">‚ñº</span>
                                                </button>
                                                <div class="accordion-content">
                                                    ${detail.data.headings.map(h => `
                                                        <div class="heading-item ${h.tag}">
                                                            <span class="heading-tag">${h.tag.toUpperCase()}</span>
                                                            <span class="heading-text">${h.text}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            ` : ''}
                                            
                                            ${detail.data.links?.length > 0 ? `
                                            <div class="accordion-item">
                                                <button class="accordion-header" onclick="toggleAccordion(this)">
                                                    <span>üîó Liens trouv√©s (${detail.data.links.length})</span>
                                                    <span class="accordion-icon">‚ñº</span>
                                                </button>
                                                <div class="accordion-content">
                                                    ${detail.data.links.map(link => `
                                                        <div class="link-item">
                                                            <a href="${link.url}" target="_blank" class="link-url">${link.url}</a>
                                                            ${link.text ? `<span class="link-text">${link.text}</span>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>` :
                                    `<div class="result-content">
                                        <div class="result-error-message">
                                            <span class="error-icon">‚ö†</span>
                                            <div>
                                                <strong>Erreur de scraping</strong><br>
                                                ${detail.error}
                                            </div>
                                        </div>
                                    </div>`
                                }
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            submitBtn.disabled = false;
        });
        
        function toggleAccordion(button) {
            const item = button.parentElement;
            const content = item.querySelector('.accordion-content');
            const icon = button.querySelector('.accordion-icon');
            
            item.classList.toggle('active');
            
            if (item.classList.contains('active')) {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.maxHeight = '0';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function setupDallozTrigger() {
            document.querySelectorAll('[data-dalloz-trigger]').forEach(btn => {
                if (btn.dataset.bound === 'true') return;
                btn.dataset.bound = 'true';
                btn.addEventListener('click', async () => {
                    const original = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = 'Lancement...';
                    try {
                        const res = await fetch('/run-dalloz-script', { method: 'POST' });
                        const data = await res.json();
                        alert(data.success ? (data.message || 'Script lanc√©') : (data.error || 'Erreur pendant le script'));
                    } catch (err) {
                        alert('Erreur de communication avec le script');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = original;
                    }
                });
            });
        }
        
        setupDallozTrigger();
        loadStats();
    </script>
</body>
</html>
